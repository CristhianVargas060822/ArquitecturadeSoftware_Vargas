<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin - Documentos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #f1f1f1;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* Columna izquierda */
    .left-panel {
      width: 35%;
      background: rgba(0,0,0,0.3);
      padding: 30px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: 2px 0 6px rgba(0,0,0,0.3);
    }
    .left-panel h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #fff;
    }
    form input, form select, form textarea, form button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
    }
    form input, form select, form textarea {
      background: #2d4a8a;
      color: #fff;
    }
    form input::placeholder, form textarea::placeholder {
      color: #ddd;
    }
    form button {
      background: #00c6ff;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    form button:hover { background: #0099cc; }
    .msg { margin-top: 12px; padding: 10px; border-radius: 6px; text-align: center; }
    .msg.success { background: #16a34a; color: #fff; }
    .msg.error { background: #dc2626; color: #fff; }

    /* Columna derecha */
    .right-panel {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }
    .right-panel h2 {
      margin-bottom: 20px;
      color: #fff;
    }

    /* Lista de documentos */
    .doc-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }
    .doc-item {
      background: #243b77;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    .doc-preview {
      background: #1b2a54;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .doc-preview img {
      width: 100%;
      object-fit: cover;
    }
    .doc-info {
      padding: 12px;
      flex-grow: 1;
      color: #eee;
    }
    .doc-info strong { color: #fff; }
    .doc-actions {
      padding: 10px;
      display: flex;
      justify-content: space-between;
    }
    .doc-actions a, .doc-actions button {
      flex: 1;
      margin: 0 4px;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-view {
      background: #00c6ff;
      color: #fff;
    }
    .btn-delete {
      background: #e3342f;
      color: #fff;
      border: none;
    }
    .small-muted { font-size: 13px; color: #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Columna izquierda -->
    <div class="left-panel">
      <h2>Subir Documento</h2>
      <form id="uploadForm">
        <input type="text" id="titulo" placeholder="TÃ­tulo" required />
        <textarea id="descripcion" placeholder="DescripciÃ³n"></textarea>
        <select id="semana" required>
          <option value="">Seleccionar semana</option>
          <option value="1">Semana 1</option>
          <option value="2">Semana 2</option>
          <option value="3">Semana 3</option>
        </select>
        <input type="file" id="file" accept="application/pdf" required />
        <button type="submit">Subir</button>
      </form>
      <div id="msg" class="msg"></div>
    </div>

    <!-- Columna derecha -->
    <div class="right-panel">
      <h2>Documentos Subidos</h2>
      <div id="docList" class="doc-list"><p class="small-muted">Cargando documentos...</p></div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // ðŸš¨ Reemplaza con tus credenciales
    const SUPABASE_URL = "https://vkvbfhyzgeykdqsvubtm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdmJmaHl6Z2V5a2Rxc3Z1YnRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTI1NzcsImV4cCI6MjA3NDQyODU3N30.Z419bluCNlePl3-5ry3K-WpVBGMMPGiOhIaiDhLisls";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("uploadForm");
    const msgBox = document.getElementById("msg");
    const docList = document.getElementById("docList");

    function showMessage(text, type="success") {
      msgBox.textContent = text;
      msgBox.className = "msg " + type;
      setTimeout(() => { msgBox.textContent = ""; msgBox.className = "msg"; }, 3000);
    }

    // Subir archivo
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const titulo = document.getElementById("titulo").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const semana = document.getElementById("semana").value;
      const file = document.getElementById("file").files[0];
      if (!file) return showMessage("Selecciona un archivo.", "error");

      const path = `${Date.now()}_${file.name}`;

      try {
        const { error: uploadError } = await supabase.storage.from("documentos").upload(path, file);
        if (uploadError) throw uploadError;

        const { data } = supabase.storage.from("documentos").getPublicUrl(path);
        const publicUrl = data.publicUrl;

        const { error: dbError } = await supabase.from("documentos").insert([
          { titulo, descripcion, semana, url: publicUrl, path }
        ]);
        if (dbError) throw dbError;

        showMessage("Documento subido con Ã©xito");
        form.reset();
        loadDocuments();
      } catch (err) {
        console.error(err);
        showMessage("Error: " + err.message, "error");
      }
    });

    async function deleteDocument(id, path) {
      if (!confirm("Â¿Seguro que quieres eliminar este documento?")) return;
      try {
        await supabase.storage.from("documentos").remove([path]);
        await supabase.from("documentos").delete().eq("id", id);
        showMessage("Documento eliminado");
        loadDocuments();
      } catch (err) {
        console.error(err);
        showMessage("Error al eliminar: " + err.message, "error");
      }
    }

    // Generar miniatura del PDF
    async function getPdfThumbnail(url) {
      const loadingTask = pdfjsLib.getDocument(url);
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(1);

      const viewport = page.getViewport({ scale: 0.5 });
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({ canvasContext: context, viewport }).promise;
      return canvas.toDataURL();
    }

    // Listar documentos
    async function loadDocuments() {
      docList.innerHTML = "<p class='small-muted'>Cargando documentos...</p>";

      const { data, error } = await supabase
        .from("documentos")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        docList.innerHTML = `<p class="small-muted">Error al cargar: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        docList.innerHTML = "<p class='small-muted'>No hay documentos subidos aÃºn.</p>";
        return;
      }

      docList.innerHTML = "";
      for (const doc of data) {
        const div = document.createElement("div");
        div.className = "doc-item";

        const preview = document.createElement("div");
        preview.className = "doc-preview";
        try {
          const thumb = await getPdfThumbnail(doc.url);
          const img = document.createElement("img");
          img.src = thumb;
          preview.appendChild(img);
        } catch {
          preview.innerHTML = "<p class='small-muted'>Sin vista previa</p>";
        }

        const info = document.createElement("div");
        info.className = "doc-info";
        info.innerHTML = `<strong>${doc.titulo} (Semana ${doc.semana || "-"})</strong>
                          <div class="small-muted">${doc.descripcion || ""}</div>
                          <div class="small-muted">Subido: ${new Date(doc.created_at).toLocaleString()}</div>`;

        const actions = document.createElement("div");
        actions.className = "doc-actions";

        const viewLink = document.createElement("a");
        viewLink.className = "btn-view";
        viewLink.href = doc.url;
        viewLink.target = "_blank";
        viewLink.textContent = "Ver";

        const delBtn = document.createElement("button");
        delBtn.className = "btn-delete";
        delBtn.textContent = "Eliminar";
        delBtn.addEventListener("click", () => deleteDocument(doc.id, doc.path));

        actions.appendChild(viewLink);
        actions.appendChild(delBtn);

        div.appendChild(preview);
        div.appendChild(info);
        div.appendChild(actions);
        docList.appendChild(div);
      }
    }

    loadDocuments();
  </script>
</body>
</html>
