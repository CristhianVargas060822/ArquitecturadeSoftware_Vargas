<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Repositorio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">

    <!-- SDK Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>
</head>

<body>
    <!-- HEADER -->
    <header class="header">
        <nav class="navbar">
            <div class="logo">
                <a href="index.html">
                    <img src="Imagenes/UPLA_Logo.png" alt="Logo UPLA" style="height: 40px; vertical-align: middle;">
                    <span style="color: #ffffff; font-weight: bold; margin-left: 8px;">UPLA</span>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Menú</a></li>
                <li><a href="Login.html" class="btn-login">Login</a></li>
            </ul>
        </nav>
    </header>

    <!-- ==== HERO ==== -->
    <section class="hero">
        <h1>ARQUITECTURA DE SOFTWARE</h1>
        <h2>Vargas Calixto Cristhian Alonso</h2>
        <p>Mi repositorio de las semanas de clases</p>
    </section>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="content">
        <h2>SEMANAS</h2>
        <!-- Contenedor donde el script insertará .semanas-container -->
        <div id="accordion-container"></div>
    </main>

    <script>
        // 🔑 Configuración Supabase (deja como estaba)
        const SUPABASE_URL = "https://vkvbfhyzgeykdqsvubtm.supabase.co";
        const SUPABASE_ANON_KEY =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdmJmaHl6Z2V5a2Rxc3Z1YnRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTI1NzcsImV4cCI6MjA3NDQyODU3N30.Z419bluCNlePl3-5ry3K-WpVBGMMPGiOhIaiDhLisls";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 🔹 Renderizar miniatura PDF (igual que antes)
        async function renderPDFThumbnail(url, canvas) {
            try {
                const pdf = await pdfjsLib.getDocument(url).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 1.5 });

                const tempCanvas = document.createElement("canvas");
                const tempCtx = tempCanvas.getContext("2d");
                tempCanvas.width = viewport.width;
                tempCanvas.height = viewport.height;

                await page.render({ canvasContext: tempCtx, viewport }).promise;

                const ctx = canvas.getContext("2d");
                canvas.width = 120;
                canvas.height = 150;
                ctx.drawImage(tempCanvas, 0, 0, viewport.width, viewport.height, 0, 0, canvas.width, canvas.height);
            } catch (err) {
                console.error("Error generando preview:", err);
            }
        }

        // 🔹 Cargar documentos y generar tarjetas + panels
        async function cargarDocumentos() {
            const { data, error } = await supabase
                .from("documentos")
                .select("*")
                .order("semana", { ascending: true });

            if (error) {
                console.error("Error al cargar documentos:", error.message);
                return;
            }

            const container = document.getElementById("accordion-container");

            // crear contenedor de semanas
            const semanasWrapper = document.createElement("div");
            semanasWrapper.classList.add("semanas-container");
            container.appendChild(semanasWrapper);

            // Agrupar documentos por semana
            const semanas = {};
            data.forEach(doc => {
                // Normaliza la semana como string/numero
                const semKey = doc.semana != null ? String(doc.semana) : "0";
                if (!semanas[semKey]) semanas[semKey] = [];
                semanas[semKey].push(doc);
            });

            // emojis para íconos (opcional)
            const emojis = ['📘', '📗', '📙', '📕', '📓', '📒'];

            // Crear tarjetas de semana
            Object.keys(semanas).forEach((sem, idx) => {
                // tarjeta (div) que actúa como botón
                const card = document.createElement("div");
                card.classList.add("semana-card", "accordion");
                card.setAttribute("role", "button");
                card.setAttribute("tabindex", "0");
                card.setAttribute("aria-expanded", "false");

                // header de la tarjeta
                const header = document.createElement("div");
                header.classList.add("semana-header");

                const iconSpan = document.createElement("span");
                iconSpan.classList.add("semana-icon");
                // asigna emoji según la semana (si es número) o por índice
                const semNum = parseInt(sem, 10);
                if (!isNaN(semNum)) {
                    iconSpan.textContent = emojis[(semNum - 1) % emojis.length] || emojis[idx % emojis.length];
                } else {
                    iconSpan.textContent = emojis[idx % emojis.length];
                }

                const titleSpan = document.createElement("span");
                titleSpan.classList.add("semana-title");
                titleSpan.textContent = `Semana ${sem}`;

                header.appendChild(iconSpan);
                header.appendChild(titleSpan);
                card.appendChild(header);

                // panel para los documentos de esta semana
                const panel = document.createElement("div");
                panel.classList.add("panel");

                const skillsContainer = document.createElement("div");
                skillsContainer.classList.add("skills-container");

                // por cada documento crear la card interna (skill)
                semanas[sem].forEach(doc => {
                    const item = document.createElement("a");
                    item.href = doc.url;
                    item.target = "_blank";
                    item.classList.add("skill");

                    // Preview PDF
                    const preview = document.createElement("div");
                    preview.classList.add("pdf-preview");
                    const canvas = document.createElement("canvas");
                    preview.appendChild(canvas);

                    const titulo = document.createElement("h3");
                    titulo.textContent = doc.titulo || "Documento";

                    const descripcion = document.createElement("p");
                    descripcion.textContent = doc.descripcion || "Sin descripción";

                    item.appendChild(preview);
                    item.appendChild(titulo);
                    item.appendChild(descripcion);
                    skillsContainer.appendChild(item);

                    // generar miniatura asincrónicamente
                    renderPDFThumbnail(doc.url, canvas);
                });

                panel.appendChild(skillsContainer);

                // añadir tarjeta + panel al wrapper
                semanasWrapper.appendChild(card);
                semanasWrapper.appendChild(panel);

                // evento click y teclado para abrir/cerrar
                const togglePanel = () => {
                    const isOpen = card.classList.toggle("active");
                    card.setAttribute("aria-expanded", String(isOpen));
                    if (isOpen) {
                        panel.classList.add("open");
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    } else {
                        panel.classList.remove("open");
                        panel.style.maxHeight = null;
                    }
                };

                card.addEventListener("click", togglePanel);
                card.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        togglePanel();
                    }
                });
            });

            // Si existiera código extra que manipula .accordion (por ejemplo script.js),
            // ya está cubierto porque usamos la clase "accordion" en las tarjetas.
        }

        // Inicializar
        cargarDocumentos();

        // Ajustar paneles abiertos al redimensionar la ventana
        window.addEventListener("resize", () => {
            document.querySelectorAll(".panel.open").forEach(panel => {
                panel.style.maxHeight = panel.scrollHeight + "px";
            });
        });
    </script>
</body>

</html>
